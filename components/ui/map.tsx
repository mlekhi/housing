"use client";

import { useEffect, useRef, useState } from "react";
import mapboxgl from "mapbox-gl";
import "mapbox-gl/dist/mapbox-gl.css";

mapboxgl.accessToken = process.env.NEXT_PUBLIC_MAPBOX_TOKEN || '';

const studentAreas = [
    {
        name: 'Masonville',
        coordinates: [-81.275, 43.015] as [number, number],
        description: 'Popular student area near Masonville Mall with multiple bus routes',
        busRoutes: ['106', '27'],
        color: '#d7b5ff', // Light purple for Masonville
        boundary: [
          [-81.2747377, 43.0289096],
          [-81.2996929, 43.0216467],
          [-81.30495, 43.0200936],
          [-81.3043358, 43.0186971],
          [-81.3062456, 43.0157006],
          [-81.2990358, 43.0127509],
          [-81.2991431, 43.010366],
          [-81.2921908, 43.0094089],
          [-81.2938001, 43.0076201],
          [-81.2907102, 43.0052193],
          [-81.2894013, 43.0062079],
          [-81.2904098, 43.0076358],
          [-81.2876632, 43.0091892],
          [-81.2868049, 43.0100365],
          [-81.2828567, 43.0082164],
          [-81.2800028, 43.0135982],
          [-81.2731578, 43.0146337],
          [-81.2718704, 43.0126411],
          [-81.2688234, 43.0122959],
          [-81.2681153, 43.0148847],
          [-81.265476, 43.0159987],
          [-81.2624719, 43.0138806],
          [-81.2535026, 43.013457],
          [-81.2550046, 43.017191],
          [-81.2522581, 43.0194658],
          [-81.2522366, 43.0223053],
          [-81.2572577, 43.0207679],
          [-81.2585451, 43.0244074],
          [-81.2710765, 43.0239527],
          [-81.2747377, 43.0289096] // Closing the polygon
        ]
      },      
  {
    name: 'Old North',
    coordinates: [-81.265, 43.005] as [number, number],
    description: 'Close to campus, popular for walking and bus routes',
    busRoutes: ['106', '27'],
    color: '#d7b5ff', // Light purple for Old North
    boundary: [
        [-81.2688234, 43.0122959],
        [-81.2670074, 43.0098373],
        [-81.2688957, 43.005381],
        [-81.2718998, 43.0025564],
        [-81.2714706, 42.9989784],
        [-81.2612568, 42.9976602],
        [-81.2612568, 42.9928891],
        [-81.2369667, 43.0001084],
        [-81.2457214, 43.0170546],
        [-81.2535026, 43.013457],
        [-81.2624719, 43.0138806],
        [-81.265476, 43.0159987],
        [-81.2681153, 43.0148847],
        [-81.2688234, 43.0122959] // Closing the polygon
      ]
      },
  {
    name: 'Downtown',
    coordinates: [-81.245, 42.985] as [number, number],
    description: 'Vibrant area with many amenities and bus connections',
    busRoutes: ['106', '27', '13'],
    color: '#d7b5ff', // Light purple for Downtown
    boundary: [
        [-81.2369667, 43.0001084],
        [-81.2612568, 42.9928891],
        [-81.2587065, 42.9903574],
        [-81.2572474, 42.9892901],
        [-81.2582774, 42.9863392],
        [-81.2565607, 42.9826975],
        [-81.2570757, 42.9807509],
        [-81.2554449, 42.9781764],
        [-81.2551016, 42.9762297],
        [-81.2510676, 42.9769833],
        [-81.2478918, 42.9743458],
        [-81.2451453, 42.9761041],
        [-81.2441153, 42.9735922],
        [-81.2419695, 42.972399],
        [-81.2398238, 42.9742202],
        [-81.2353606, 42.9748482],
        [-81.2333006, 42.9734038],
        [-81.2308974, 42.9743458],
        [-81.2256939, 42.975068],
        [-81.2369667, 43.0001084] // Closing the polygon
        ]
  },
  {
    name: 'Oxford/Wharncliffe',
    coordinates: [-81.255, 42.995] as [number, number],
    description: 'South-side student area with good bus access',
    busRoutes: ['106', '27'],
    color: '#d7b5ff', // Light purple for Oxford/Wharncliffe
    boundary: [
        [-81.2718998, 43.0025564],
        [-81.2766605, 43.0018687],
        [-81.2759739, 42.9970352],
        [-81.2714248, 42.9898156],
        [-81.275888, 42.9887482],
        [-81.2742572, 42.9823439],
        [-81.2674766, 42.9830974],
        [-81.256662, 42.9822811],
        [-81.2582774, 42.9863392],
        [-81.2572474, 42.9892901],
        [-81.2612568, 42.9928891],
        [-81.2612568, 42.9976602],
        [-81.2714706, 42.9989784],
        [-81.2718998, 43.0025564] // Closing the polygon
        ]
  },
  {
    name: 'West of Campus',
    coordinates: [-81.285, 43.005] as [number, number],
    description: 'Sarnia and Wonderland area with multiple bus routes',
    busRoutes: ['106', '27'],
    color: '#d7b5ff', // Light purple for West of Campus
    boundary: [
        [-81.3047334, 43.0075252],
        [-81.2938329, 42.9861186],
        [-81.2714248, 42.9898156],
        [-81.2759739, 42.9970352],
        [-81.2766605, 43.0018687],
        [-81.2776109, 43.0111027],
        [-81.2764951, 43.0141151],
        [-81.2800028, 43.0135982],
        [-81.2828567, 43.0082164],
        [-81.2868049, 43.0100365],
        [-81.2876632, 43.0091892],
        [-81.2904098, 43.0076358],
        [-81.2894013, 43.0062079],
        [-81.2907102, 43.0052193],
        [-81.2938001, 43.0076201],
        [-81.2921908, 43.0094089],
        [-81.2953778, 43.009973],
        [-81.3047334, 43.0075252] // Closing the polygon
        ]
  }
];

const busRoutes = [
    {
      id: '106',
      name: 'Richmond',
      color: '#3b82f6', // blue
      coordinates: [
        [-81.250369, 42.985043],
        [-81.249919, 42.985128],
        [-81.248224, 42.985598],
        [-81.245931, 42.986246],
        [-81.245278, 42.984971],
        [-81.244682, 42.983766],
        [-81.24697, 42.983141],
        [-81.249107, 42.982558],
        [-81.250369, 42.985043],
        [-81.250574, 42.985517],
        [-81.250707, 42.986647],
        [-81.250727, 42.986881],
        [-81.250725, 42.987399],
        [-81.250741, 42.98804],
        [-81.250753, 42.988581],
        [-81.250764, 42.98926],
        [-81.250775, 42.989892],
        [-81.250768, 42.99046],
        [-81.250768, 42.99054],
        [-81.2508, 42.990786],
        [-81.250854, 42.991009],
        [-81.251065, 42.99141],
        [-81.251305, 42.991867],
        [-81.251607, 42.992439],
        [-81.251814, 42.992833],
        [-81.252348, 42.993855],
        [-81.252669, 42.994469],
        [-81.253218, 42.995521],
        [-81.253762, 42.996569],
        [-81.254289, 42.997625],
        [-81.254803, 42.998642],
        [-81.25533, 42.999673],
        [-81.255866, 43.000697],
        [-81.255983, 43.000943],
        [-81.256383, 43.001713],
        [-81.256915, 43.002736],
        [-81.257442, 43.003751],
        [-81.257978, 43.004787],
        [-81.258015, 43.00486],
        [-81.258502, 43.005809],
        [-81.258941, 43.006667],
        [-81.259208, 43.007078],
        [-81.260191, 43.008026],
        [-81.261314, 43.009098],
        [-81.265803, 43.007768],
        [-81.26624, 43.00764],
        [-81.266551, 43.007591],
        [-81.266803, 43.007587],
        [-81.266979, 43.007603],
        [-81.268985, 43.007881],
        [-81.269936, 43.008026],
        [-81.270258, 43.008075],
        [-81.270434, 43.008127],
        [-81.270592, 43.008208],
        [-81.27071, 43.008281],
        [-81.270822, 43.008367],
        [-81.271122, 43.00871],
        [-81.271223, 43.008848],
        [-81.271399, 43.00903],
        [-81.271493, 43.009103],
        [-81.271576, 43.009154],
        [-81.271808, 43.00934],
        [-81.271823, 43.009433],
        [-81.271871, 43.009554],
        [-81.272136, 43.010026],
        [-81.27216, 43.010104],
        [-81.272167, 43.01022],
        [-81.272231, 43.010306],
        [-81.27232, 43.01034],
        [-81.272425, 43.01034],
        [-81.272542, 43.010322],
        [-81.273005, 43.010201],
        [-81.274146, 43.009856],
        [-81.274321, 43.009781],
        [-81.274761, 43.009827],
        [-81.275015, 43.009863],
        [-81.275161, 43.009896],
        [-81.275727, 43.010132],
        [-81.275925, 43.010195],
        [-81.27609, 43.010243],
        [-81.276215, 43.01027],
        [-81.27635, 43.010296],
        [-81.276466, 43.010305],
        [-81.276594, 43.01031],
        [-81.276789, 43.010314],
        [-81.277357, 43.010294],
        [-81.277107, 43.007856],
        [-81.276942, 43.005947],
        [-81.276687, 43.003691],
        [-81.276529, 43.002079],
        [-81.276222, 42.998897],
        [-81.276153, 42.99818],
        [-81.276123, 42.997967],
        [-81.276064, 42.997753],
        [-81.275956, 42.997512],
        [-81.275751, 42.997256],
        [-81.275488, 42.997029],
        [-81.275119, 42.996767],
        [-81.274893, 42.996666],
        [-81.274769, 42.996611],
        [-81.274342, 42.99647],
        [-81.274128, 42.996427],
        [-81.273857, 42.996414],
        [-81.273295, 42.996415],
        [-81.272512, 42.996461],
        [-81.272324, 42.996468],
        [-81.272127, 42.996456],
        [-81.271881, 42.996439],
        [-81.270492, 42.99619],
        [-81.268533, 42.995839],
        [-81.26733, 42.995622],
        [-81.267133, 42.995574],
        [-81.267009, 42.995529],
        [-81.266952, 42.995508],
        [-81.266837, 42.995448],
        [-81.266664, 42.995316],
        [-81.266539, 42.995133],
        [-81.266499, 42.995076],
        [-81.266316, 42.994736],
        [-81.265937, 42.99403],
        [-81.265726, 42.993672],
        [-81.265699, 42.993599],
        [-81.26566, 42.993431],
        [-81.265477, 42.992998],
        [-81.265106, 42.992415],
        [-81.264914, 42.992024],
        [-81.264655, 42.991526],
        [-81.26453, 42.991285],
        [-81.264122, 42.990574],
        [-81.264062, 42.990459],
        [-81.263515, 42.989415],
        [-81.263435, 42.989261],
        [-81.263307, 42.989016],
        [-81.2631, 42.988621],
        [-81.263062, 42.988435],
        [-81.263044, 42.988064]
      ]
    },
    {
      id: '102',
      name: 'Highbury',
      color: '#10b981', // green
      coordinates: [
        [-81.250369, 42.985043],
        [-81.249919, 42.985128],
        [-81.248224, 42.985598],
        [-81.245931, 42.986246],
        [-81.245278, 42.984971],
        [-81.244682, 42.983766],
        [-81.24697, 42.983141],
        [-81.249107, 42.982558],
        [-81.249708, 42.983751],
        [-81.250035, 42.984365],
        [-81.25029, 42.984859],
        [-81.250369, 42.985043],
        [-81.250574, 42.985517],
        [-81.250707, 42.986647],
        [-81.250727, 42.986881],
        [-81.250725, 42.987399],
        [-81.250741, 42.98804],
        [-81.250753, 42.988581],
        [-81.250764, 42.98926],
        [-81.250775, 42.989892],
        [-81.250768, 42.99046],
        [-81.250768, 42.99054],
        [-81.2508, 42.990786],
        [-81.250854, 42.991009],
        [-81.251065, 42.99141],
        [-81.251305, 42.991867],
        [-81.251607, 42.992439],
        [-81.251814, 42.992833],
        [-81.252348, 42.993855],
        [-81.252669, 42.994469],
        [-81.253218, 42.995521],
        [-81.253762, 42.996569],
        [-81.254289, 42.997625],
        [-81.254803, 42.998642],
        [-81.25533, 42.999673],
        [-81.255866, 43.000697],
        [-81.255983, 43.000943],
        [-81.256383, 43.001713],
        [-81.256915, 43.002736],
        [-81.257442, 43.003751],
        [-81.257978, 43.004787],
        [-81.258015, 43.00486],
        [-81.258502, 43.005809],
        [-81.258941, 43.006667],
        [-81.259208, 43.007078],
        [-81.260191, 43.008026],
        [-81.261314, 43.009098],
        [-81.262057, 43.009802],
        [-81.262631, 43.010345],
        [-81.262972, 43.010668],
        [-81.26346, 43.011129],
        [-81.263855, 43.011503],
        [-81.2646, 43.012206],
        [-81.265857, 43.013393],
        [-81.266464, 43.013942],
        [-81.266662, 43.014072],
        [-81.266923, 43.014201],
        [-81.267215, 43.0143],
        [-81.268674, 43.01464],
        [-81.269362, 43.014822],
        [-81.269655, 43.014978],
        [-81.272084, 43.016352],
        [-81.27354, 43.015898],
        [-81.275253, 43.015383],
        [-81.276058, 43.015147],
        [-81.276707, 43.014991],
        [-81.276683, 43.014857],
        [-81.276679, 43.014821],
        [-81.276675, 43.014774],
        [-81.276655, 43.014581],
        [-81.276645, 43.014226],
        [-81.276689, 43.013945],
        [-81.276732, 43.013674],
        [-81.276794, 43.013483],
        [-81.27698, 43.013012],
        [-81.277157, 43.012624],
        [-81.277281, 43.012295],
        [-81.27736, 43.012012],
        [-81.277413, 43.011788],
        [-81.277446, 43.011246],
        [-81.277437, 43.011148],
        [-81.277357, 43.010294],
        [-81.276789, 43.010314],
        [-81.276594, 43.01031],
        [-81.276466, 43.010305],
        [-81.27635, 43.010296],
        [-81.276215, 43.01027],
        [-81.27609, 43.010243],
        [-81.275925, 43.010195],
        [-81.275727, 43.010132],
        [-81.275161, 43.009896],
        [-81.275015, 43.009863],
        [-81.274761, 43.009827],
        [-81.274321, 43.009781],
        [-81.274146, 43.009856],
        [-81.273005, 43.010201],
        [-81.272542, 43.010322],
        [-81.272425, 43.01034],
        [-81.27232, 43.01034],
        [-81.272231, 43.010306],
        [-81.272167, 43.01022],
        [-81.27216, 43.010104],
        [-81.272136, 43.010026],
        [-81.271871, 43.009554],
        [-81.271823, 43.009433],
        [-81.271808, 43.00934],
        [-81.271576, 43.009154],
        [-81.271493, 43.009103],
        [-81.271399, 43.00903],
        [-81.271223, 43.008848],
        [-81.271122, 43.00871],
        [-81.270822, 43.008367],
        [-81.27071, 43.008281],
        [-81.270592, 43.008208],
        [-81.270434, 43.008127],
        [-81.270258, 43.008075],
        [-81.269936, 43.008026],
        [-81.269987, 43.007734],
        [-81.270032, 43.007364],
        [-81.270141, 43.006893],
        [-81.270297, 43.006436],
        [-81.270361, 43.006337],
        [-81.270467, 43.006251],
        [-81.270601, 43.006194],
        [-81.270724, 43.006151],
        [-81.270871, 43.006138],
        [-81.271258, 43.006184],
        [-81.271817, 43.006317],
        [-81.273206, 43.006642],
        [-81.273479, 43.006681],
        [-81.273868, 43.00658],
        [-81.274032, 43.00649],
        [-81.274184, 43.00642],
        [-81.274313, 43.006377],
        [-81.274576, 43.006303],
        [-81.274711, 43.006251],
        [-81.274903, 43.006211]
          ]
    },
    {
      id: '2',
      name: 'Wellington',
      color: '#f59e0b', // amber
      coordinates: [
        [-81.276942, 43.005947],
        [-81.277107, 43.007856],
        [-81.277357, 43.010294],
        [-81.276789, 43.010314],
        [-81.276594, 43.01031],
        [-81.276466, 43.010305],
        [-81.27635, 43.010296],
        [-81.276215, 43.01027],
        [-81.27609, 43.010243],
        [-81.275925, 43.010195],
        [-81.275727, 43.010132],
        [-81.275161, 43.009896],
        [-81.275015, 43.009863],
        [-81.274761, 43.009827],
        [-81.274321, 43.009781],
        [-81.274146, 43.009856],
        [-81.273005, 43.010201],
        [-81.272542, 43.010322],
        [-81.272425, 43.01034],
        [-81.27232, 43.01034],
        [-81.272231, 43.010306],
        [-81.272167, 43.01022],
        [-81.27216, 43.010104],
        [-81.272136, 43.010026],
        [-81.271871, 43.009554],
        [-81.271823, 43.009433],
        [-81.271808, 43.00934],
        [-81.271576, 43.009154],
        [-81.271493, 43.009103],
        [-81.271399, 43.00903],
        [-81.271223, 43.008848],
        [-81.271122, 43.00871],
        [-81.270822, 43.008367],
        [-81.27071, 43.008281],
        [-81.270592, 43.008208],
        [-81.270434, 43.008127],
        [-81.270258, 43.008075],
        [-81.269936, 43.008026],
        [-81.269987, 43.007734],
        [-81.270032, 43.007364],
        [-81.270141, 43.006893],
        [-81.270297, 43.006436],
        [-81.270361, 43.006337],
        [-81.270467, 43.006251],
        [-81.270601, 43.006194],
        [-81.270724, 43.006151],
        [-81.270871, 43.006138],
        [-81.271258, 43.006184],
        [-81.271817, 43.006317],
        [-81.273206, 43.006642],
        [-81.273479, 43.006681],
        [-81.273868, 43.00658],
        [-81.274032, 43.00649],
        [-81.274184, 43.00642],
        [-81.274313, 43.006377],
        [-81.274576, 43.006303],
        [-81.274711, 43.006251],
        [-81.274903, 43.006211],
        [-81.274918, 43.006151],
        [-81.274968, 43.006096],
        [-81.275037, 43.006057],
        [-81.275119, 43.006045],
        [-81.275231, 43.006037],
        [-81.275355, 43.006061],
        [-81.275414, 43.006112],
        [-81.275642, 43.006056],
        [-81.276942, 43.005947],
        [-81.276687, 43.003691],
        [-81.276529, 43.002079],
        [-81.276222, 42.998897],
        [-81.276153, 42.99818],
        [-81.276123, 42.997967],
        [-81.276064, 42.997753],
        [-81.275956, 42.997512],
        [-81.275751, 42.997256],
        [-81.275488, 42.997029],
        [-81.275119, 42.996767],
        [-81.274893, 42.996666],
        [-81.274769, 42.996611],
        [-81.274342, 42.99647],
        [-81.274128, 42.996427],
        [-81.273857, 42.996414],
        [-81.273295, 42.996415],
        [-81.272512, 42.996461],
        [-81.272324, 42.996468],
        [-81.272127, 42.996456],
        [-81.271881, 42.996439],
        [-81.270492, 42.99619],
        [-81.268533, 42.995839],
        [-81.26733, 42.995622],
        [-81.267133, 42.995574],
        [-81.267009, 42.995529],
        [-81.266952, 42.995508],
        [-81.266837, 42.995448],
        [-81.266664, 42.995316],
        [-81.266539, 42.995133],
        [-81.266499, 42.995076],
        [-81.266316, 42.994736],
        [-81.265937, 42.99403],
        [-81.265726, 42.993672],
        [-81.265699, 42.993599],
        [-81.26566, 42.993431],
        [-81.265477, 42.992998],
        [-81.265106, 42.992415],
        [-81.264914, 42.992024],
        [-81.264655, 42.991526],
        [-81.26453, 42.991285],
        [-81.264122, 42.990574],
        [-81.264062, 42.990459],
        [-81.263515, 42.989415],
        [-81.263435, 42.989261],
        [-81.263307, 42.989016],
        [-81.2631, 42.988621],
        [-81.263062, 42.988435],
        [-81.263044, 42.988064],
        [-81.263006, 42.98753],
        [-81.262973, 42.986851],
        [-81.262953, 42.986424],
        [-81.262924, 42.985823],
        [-81.262914, 42.985264],
        [-81.262905, 42.9847],
        [-81.262834, 42.983874],
        [-81.262795, 42.983407],
        [-81.262727, 42.982918],
        [-81.260969, 42.982868],
        [-81.260143, 42.982809],
        [-81.259685, 42.982777]
          ]
    },
    {
      id: '93',
      name: 'Wharncliffe',
      color: '#8b5cf6', // purple
      coordinates: [
        [-81.281775, 43.025011],
        [-81.281417, 43.025077],
        [-81.280982, 43.023518],
        [-81.279952, 43.021544],
        [-81.279833, 43.021334],
        [-81.279585, 43.020899],
        [-81.27945, 43.020743],
        [-81.279271, 43.020533],
        [-81.278821, 43.020183],
        [-81.278668, 43.020095],
        [-81.278842, 43.019919],
        [-81.278911, 43.019846],
        [-81.27895, 43.019795],
        [-81.278963, 43.019757],
        [-81.278966, 43.019699],
        [-81.27896, 43.019591],
        [-81.278793, 43.01932],
        [-81.278272, 43.018326],
        [-81.277733, 43.017294],
        [-81.276957, 43.015866],
        [-81.276793, 43.015458],
        [-81.276707, 43.014991],
        [-81.276683, 43.014857],
        [-81.276679, 43.014821],
        [-81.276675, 43.014774],
        [-81.276655, 43.014581],
        [-81.276645, 43.014226],
        [-81.276689, 43.013945],
        [-81.276732, 43.013674],
        [-81.276794, 43.013483],
        [-81.27698, 43.013012],
        [-81.277157, 43.012624],
        [-81.277281, 43.012295],
        [-81.27736, 43.012012],
        [-81.277413, 43.011788],
        [-81.277446, 43.011246],
        [-81.277437, 43.011148],
        [-81.277357, 43.010294],
        [-81.277107, 43.007856],
        [-81.276942, 43.005947],
        [-81.276687, 43.003691],
        [-81.276529, 43.002079],
        [-81.276222, 42.998897],
        [-81.276153, 42.99818],
        [-81.276123, 42.997967],
        [-81.276064, 42.997753],
        [-81.275956, 42.997512],
        [-81.275751, 42.997256],
        [-81.275488, 42.997029],
        [-81.275119, 42.996767],
        [-81.274893, 42.996666],
        [-81.274769, 42.996611],
        [-81.274342, 42.99647],
        [-81.274128, 42.996427],
        [-81.273857, 42.996414],
        [-81.273295, 42.996415],
        [-81.272512, 42.996461],
        [-81.272324, 42.996468],
        [-81.272127, 42.996456],
        [-81.271881, 42.996439],
        [-81.270492, 42.99619],
        [-81.268533, 42.995839],
        [-81.26733, 42.995622],
        [-81.267133, 42.995574],
        [-81.267009, 42.995529],
        [-81.266952, 42.995508],
        [-81.266837, 42.995448],
        [-81.266664, 42.995316],
        [-81.266539, 42.995133],
        [-81.266499, 42.995076],
        [-81.266316, 42.994736],
        [-81.265937, 42.99403],
        [-81.265726, 42.993672],
        [-81.265699, 42.993599],
        [-81.26566, 42.993431],
        [-81.265477, 42.992998],
        [-81.265106, 42.992415],
        [-81.264914, 42.992024],
        [-81.264655, 42.991526],
        [-81.26453, 42.991285],
        [-81.264122, 42.990574],
        [-81.264062, 42.990459],
        [-81.263515, 42.989415],
        [-81.263435, 42.989261],
        [-81.263307, 42.989016],
        [-81.2631, 42.988621],
        [-81.263062, 42.988435],
        [-81.263044, 42.988064],
        [-81.263006, 42.98753],
        [-81.262973, 42.986851],
        [-81.262953, 42.986424],
        [-81.262924, 42.985823],
        [-81.262914, 42.985264],
        [-81.262905, 42.9847],
        [-81.262834, 42.983874],
        [-81.262795, 42.983407],
        [-81.262727, 42.982918],
        [-81.262712, 42.982509],
        [-81.26258, 42.981114],
        [-81.262556, 42.980855],
        [-81.262531, 42.980495],
        [-81.262452, 42.979365],
        [-81.262417, 42.978779],
        [-81.262397, 42.978462],
        [-81.262359, 42.977828],
        [-81.262341, 42.97753],
        [-81.262296, 42.976784],
        [-81.262232, 42.975769],
        [-81.262176, 42.97487],
        [-81.262132, 42.974157],
        [-81.262103, 42.97386],
        [-81.262025, 42.972829],
        [-81.262002, 42.972525],
        [-81.261945, 42.971761],
        [-81.261917, 42.971388],
        [-81.261824, 42.970161],
        [-81.261765, 42.969317],
        [-81.261731, 42.968803],
        [-81.261699, 42.968317],
        [-81.26164, 42.967432],
        [-81.261554, 42.966133],
        [-81.261463, 42.964912],
        [-81.261374, 42.963705],
        [-81.261288, 42.962553],
        [-81.26128, 42.962423]
          ]
    },
    {
      id: '33',
      name: 'Oxford',
      color: '#06b6d4', // cyan
      coordinates: [
        [-81.28798, 42.985216],
        [-81.288999, 42.987269],
        [-81.289343, 42.987169],
        [-81.289802, 42.987],
        [-81.290804, 42.986569],
        [-81.291492, 42.986255],
        [-81.29165, 42.986203],
        [-81.292569, 42.985941],
        [-81.293571, 42.98567],
        [-81.292657, 42.983869],
        [-81.28798, 42.985216],
        [-81.28778, 42.984801],
        [-81.287619, 42.984554],
        [-81.287494, 42.984432],
        [-81.287357, 42.984324],
        [-81.287208, 42.984233],
        [-81.285204, 42.983369],
        [-81.284889, 42.983288],
        [-81.284682, 42.983262],
        [-81.284486, 42.983249],
        [-81.284314, 42.983259],
        [-81.284148, 42.983276],
        [-81.283941, 42.983316],
        [-81.283751, 42.983364],
        [-81.283036, 42.983584],
        [-81.282831, 42.983647],
        [-81.282393, 42.983766],
        [-81.282233, 42.983823],
        [-81.282085, 42.983893],
        [-81.281932, 42.98398],
        [-81.281719, 42.984072],
        [-81.281446, 42.984164],
        [-81.279865, 42.98464],
        [-81.281191, 42.987257],
        [-81.276153, 42.98873],
        [-81.2764, 42.989147],
        [-81.276518, 42.989277],
        [-81.276646, 42.989374],
        [-81.277518, 42.990142],
        [-81.277706, 42.99034],
        [-81.277794, 42.990448],
        [-81.278128, 42.991074],
        [-81.277147, 42.991366],
        [-81.276982, 42.991427],
        [-81.276754, 42.991524],
        [-81.276563, 42.991622],
        [-81.276338, 42.991723],
        [-81.275853, 42.991887],
        [-81.275661, 42.99193],
        [-81.275465, 42.991963],
        [-81.275308, 42.991974],
        [-81.275112, 42.991971],
        [-81.274935, 42.99195],
        [-81.274424, 42.99184],
        [-81.27408, 42.991747],
        [-81.273771, 42.991722],
        [-81.273624, 42.991741],
        [-81.272928, 42.991922],
        [-81.273239, 42.992516],
        [-81.273598, 42.993096],
        [-81.273628, 42.993233],
        [-81.273652, 42.993344],
        [-81.274487, 42.994884],
        [-81.274922, 42.995735],
        [-81.275111, 42.9961],
        [-81.275138, 42.996218],
        [-81.275112, 42.996323],
        [-81.274893, 42.996666],
        [-81.275119, 42.996767],
        [-81.275488, 42.997029],
        [-81.275751, 42.997256],
        [-81.275956, 42.997512],
        [-81.276064, 42.997753],
        [-81.276123, 42.997967],
        [-81.276153, 42.99818],
        [-81.276222, 42.998897],
        [-81.276529, 43.002079],
        [-81.276687, 43.003691],
        [-81.276942, 43.005947],
        [-81.275642, 43.006056],
        [-81.275414, 43.006112],
        [-81.275426, 43.006196],
        [-81.275408, 43.006269],
        [-81.27535, 43.006329],
        [-81.275268, 43.006377],
        [-81.275192, 43.006394],
        [-81.275098, 43.006386],
        [-81.274992, 43.006359],
        [-81.274936, 43.006309],
        [-81.274912, 43.006251],
        [-81.274903, 43.006211],
        [-81.274918, 43.006151],
        [-81.274968, 43.006096],
        [-81.275037, 43.006057],
        [-81.275119, 43.006045],
        [-81.275231, 43.006037],
        [-81.275355, 43.006061],
        [-81.275414, 43.006112]
          ]
    },
    {
      id: '10',
      name: 'Huron',
      color: '#f97316', // orange
      coordinates: [
        [-81.291621, 42.947465],
        [-81.2902, 42.947636],
        [-81.290414, 42.948391],
        [-81.289334, 42.948535],
        [-81.291621, 42.947465],
        [-81.291457, 42.946811],
        [-81.291621, 42.947465],
        [-81.293042, 42.947311],
        [-81.293097, 42.94718],
        [-81.292935, 42.947083],
        [-81.292823, 42.947023],
        [-81.292759, 42.946979],
        [-81.292726, 42.946952],
        [-81.292677, 42.946887],
        [-81.292639, 42.94682],
        [-81.292539, 42.94667],
        [-81.291457, 42.946811],
        [-81.291457, 42.946811],
        [-81.290343, 42.946942],
        [-81.289041, 42.947117],
        [-81.288987, 42.947135],
        [-81.289334, 42.948535],
        [-81.288987, 42.947135],
        [-81.289334, 42.948535],
        [-81.289374, 42.948694],
        [-81.289934, 42.951054],
        [-81.290186, 42.952082],
        [-81.290681, 42.954175],
        [-81.29094, 42.955214],
        [-81.291081, 42.955708],
        [-81.291131, 42.955847],
        [-81.291233, 42.95605],
        [-81.291379, 42.956278],
        [-81.2916, 42.956559],
        [-81.292538, 42.957482],
        [-81.292729, 42.957692],
        [-81.292898, 42.957912],
        [-81.293163, 42.958337],
        [-81.293273, 42.958538],
        [-81.293386, 42.958814],
        [-81.293516, 42.959235],
        [-81.293537, 42.95946],
        [-81.293558, 42.959959],
        [-81.29355, 42.960325],
        [-81.293533, 42.960571],
        [-81.2934, 42.961061],
        [-81.29331, 42.961314],
        [-81.293051, 42.961967],
        [-81.29297, 42.962234],
        [-81.292909, 42.96265],
        [-81.292928, 42.96293],
        [-81.292975, 42.963262],
        [-81.293057, 42.963636],
        [-81.29329, 42.964683],
        [-81.293632, 42.966056],
        [-81.293725, 42.966482],
        [-81.293762, 42.966728],
        [-81.293781, 42.966955],
        [-81.293773, 42.967174],
        [-81.293747, 42.967407],
        [-81.293703, 42.967627],
        [-81.29364, 42.967824],
        [-81.293578, 42.96807],
        [-81.293489, 42.968343],
        [-81.293309, 42.96869],
        [-81.293102, 42.96901],
        [-81.292688, 42.9696],
        [-81.292535, 42.969847],
        [-81.292338, 42.97026],
        [-81.292239, 42.970514],
        [-81.292163, 42.970756],
        [-81.292038, 42.971151],
        [-81.291864, 42.97173],
        [-81.291436, 42.973152],
        [-81.291105, 42.974291],
        [-81.290882, 42.974927],
        [-81.290622, 42.975527],
        [-81.290424, 42.975927],
        [-81.290141, 42.976437],
        [-81.28993, 42.976817],
        [-81.289849, 42.97703],
        [-81.289787, 42.977403],
        [-81.289779, 42.977609],
        [-81.289789, 42.977796],
        [-81.289827, 42.978015],
        [-81.289882, 42.978255],
        [-81.289983, 42.978504],
        [-81.290211, 42.978968],
        [-81.290835, 42.980236],
        [-81.290875, 42.980317],
        [-81.291595, 42.981765],
        [-81.291768, 42.982114],
        [-81.292657, 42.983869],
        [-81.293571, 42.98567],
        [-81.294447, 42.98735],
        [-81.295692, 42.989734],
        [-81.297078, 42.992409],
        [-81.29726, 42.99276],
        [-81.298294, 42.994756],
        [-81.29875, 42.995564],
        [-81.297477, 42.995917],
        [-81.29669, 42.996148],
        [-81.29536, 42.996538],
        [-81.293255, 42.997156],
        [-81.292613, 42.997342],
        [-81.291337, 42.997713],
        [-81.290373, 42.997993],
        [-81.288883, 42.998426],
        [-81.287685, 42.99875],
        [-81.286811, 42.999001],
        [-81.285421, 42.999421],
        [-81.28328, 43.000067],
        [-81.282741, 43.000229],
        [-81.281507, 43.000601],
        [-81.279298, 43.001261],
        [-81.276529, 43.002079],
        [-81.276687, 43.003691],
        [-81.276942, 43.005947]
          ]
    },
    {
      id: '27',
      name: 'Fanshawe',
      color: '#a855f7', // violet
      coordinates: [
        [-81.295692, 42.989734],
        [-81.29848, 42.988899],
        [-81.300205, 42.988385],
        [-81.300026, 42.98798],
        [-81.299785, 42.987459],
        [-81.298988, 42.985827],
        [-81.298832, 42.985512],
        [-81.298668, 42.985414],
        [-81.298311, 42.985215],
        [-81.298162, 42.985155],
        [-81.297672, 42.984955],
        [-81.297609, 42.984929],
        [-81.297545, 42.984899],
        [-81.297392, 42.984819],
        [-81.297195, 42.984691],
        [-81.297068, 42.984589],
        [-81.296872, 42.984386],
        [-81.296042, 42.982863],
        [-81.293974, 42.983487],
        [-81.292657, 42.983869],
        [-81.293571, 42.98567],
        [-81.294447, 42.98735],
        [-81.295692, 42.989734],
        [-81.297078, 42.992409],
        [-81.29726, 42.99276],
        [-81.298294, 42.994756],
        [-81.29875, 42.995564],
        [-81.297477, 42.995917],
        [-81.29669, 42.996148],
        [-81.29536, 42.996538],
        [-81.293255, 42.997156],
        [-81.292613, 42.997342],
        [-81.291337, 42.997713],
        [-81.290373, 42.997993],
        [-81.288883, 42.998426],
        [-81.287685, 42.99875],
        [-81.286811, 42.999001],
        [-81.285421, 42.999421],
        [-81.28328, 43.000067],
        [-81.282741, 43.000229],
        [-81.281507, 43.000601],
        [-81.279298, 43.001261],
        [-81.276529, 43.002079],
        [-81.276687, 43.003691],
        [-81.276942, 43.005947],
        [-81.277107, 43.007856],
        [-81.277357, 43.010294],
        [-81.276789, 43.010314],
        [-81.275727, 43.010132],
        [-81.274761, 43.009827],
        [-81.273005, 43.010201],
        [-81.271871, 43.009554],
        [-81.270822, 43.008367],
        [-81.269936, 43.008026],
        [-81.268985, 43.007881],
        [-81.266979, 43.007603],
        [-81.265803, 43.007768],
        [-81.261314, 43.009098],
        [-81.260191, 43.008026],
        [-81.259208, 43.007078],
        [-81.258196, 43.007379],
        [-81.257014, 43.007732],
        [-81.255376, 43.008224],
        [-81.252612, 43.009033],
        [-81.250134, 43.009763],
        [-81.249657, 43.009903],
        [-81.248859, 43.009758],
        [-81.248417, 43.009499],
        [-81.247958, 43.008739],
        [-81.246825, 43.009054],
        [-81.245188, 43.009512],
        [-81.245799, 43.01085],
        [-81.244792, 43.011352],
        [-81.243123, 43.011853],
        [-81.244427, 43.014392],
        [-81.245816, 43.017188],
        [-81.241779, 43.018845],
        [-81.239916, 43.019379],
        [-81.237286, 43.020155],
        [-81.236132, 43.019869],
        [-81.234949, 43.019135],
        [-81.233531, 43.019067],
        [-81.232519, 43.018727],
        [-81.231911, 43.017982],
        [-81.231536, 43.015329],
        [-81.228123, 43.016241],
        [-81.226097, 43.016839],
        [-81.224434, 43.017329],
        [-81.21994, 43.018621],
        [-81.217792, 43.01924],
        [-81.215502, 43.019909],
        [-81.210192, 43.021467],
        [-81.207884, 43.022131],
        [-81.204772, 43.023037],
        [-81.203535, 43.020575],
        [-81.201885, 43.017204],
        [-81.201563, 43.016579],
        [-81.201287, 43.016261],
        [-81.200936, 43.016023],
        [-81.200239, 43.015788],
        [-81.198065, 43.015502],
        [-81.197573, 43.015373],
        [-81.197049, 43.015076],
        [-81.196535, 43.01438],
        [-81.1986, 43.013811]
          ]
    },
    {
      id: '13',
      name: 'Dundas',
      color: '#ec4899', // pink
      coordinates: [
    [-81.281786, 43.025059],
    [-81.281602, 43.025284],
    [-81.281737, 43.025518],
    [-81.281847, 43.025806],
    [-81.281896, 43.02595],
    [-81.281811, 43.02604],
    [-81.281688, 43.02604],
    [-81.281565, 43.025842],
    [-81.28143, 43.025608],
    [-81.281295, 43.02541],
    [-81.281172, 43.025392],
    [-81.281086, 43.025302],
    [-81.281197, 43.025167],
    [-81.281775, 43.025011],
    [-81.280982, 43.023518],
    [-81.279952, 43.021544],
    [-81.279833, 43.021334],
    [-81.279585, 43.020899],
    [-81.279271, 43.020533],
    [-81.278821, 43.020183],
    [-81.278668, 43.020095],
    [-81.275261, 43.018158],
    [-81.273448, 43.017123],
    [-81.272084, 43.016352],
    [-81.27354, 43.015898],
    [-81.275253, 43.015383],
    [-81.274712, 43.01436],
    [-81.274197, 43.013388],
    [-81.273896, 43.012776],
    [-81.273778, 43.012612],
    [-81.273207, 43.012214],
    [-81.272162, 43.011827],
    [-81.271757, 43.011656],
    [-81.271504, 43.011493],
    [-81.271263, 43.011291],
    [-81.269838, 43.009976],
    [-81.269726, 43.009864],
    [-81.269585, 43.009639],
    [-81.269537, 43.00954],
    [-81.269525, 43.009355],
    [-81.269906, 43.008195],
    [-81.269936, 43.008026],
    [-81.268985, 43.007881],
    [-81.266979, 43.007603],
    [-81.266551, 43.007591],
    [-81.26624, 43.00764],
    [-81.265803, 43.007768],
    [-81.261314, 43.009098],
    [-81.260191, 43.008026],
    [-81.259208, 43.007078],
    [-81.258941, 43.006667],
    [-81.258015, 43.00486],
    [-81.257978, 43.004787],
    [-81.256383, 43.001713],
    [-81.255866, 43.000697],
    [-81.254803, 42.998642],
    [-81.253218, 42.995521],
    [-81.252348, 42.993855],
    [-81.251305, 42.991867],
    [-81.250768, 42.99054],
    [-81.250753, 42.988581],
    [-81.250725, 42.987399],
    [-81.250574, 42.985517],
    [-81.250369, 42.985043],
    [-81.248224, 42.985598],
    [-81.245931, 42.986246],
    [-81.244682, 42.983766],
    [-81.244088, 42.982567],
    [-81.242929, 42.980189],
    [-81.240569, 42.975423],
    [-81.239792, 42.97433],
    [-81.238276, 42.972483],
    [-81.237206, 42.971159],
    [-81.236176, 42.969828],
    [-81.2358, 42.96944],
    [-81.23488, 42.968936],
    [-81.232354, 42.96692],
    [-81.231942, 42.965162],
    [-81.231503, 42.963314],
    [-81.230256, 42.958275],
    [-81.228788, 42.952246],
    [-81.227836, 42.947954],
    [-81.226225, 42.944332],
    [-81.22583, 42.943521],
    [-81.224025, 42.935853],
    [-81.22358, 42.934487],
    [-81.223134, 42.933598],
    [-81.222576, 42.932797],
    [-81.221278, 42.931478],
    [-81.219716, 42.929606],
    [-81.218201, 42.927094],
    [-81.217023, 42.925945],
    [-81.218637, 42.925803],
    [-81.219406, 42.92896]
      ]
    },
    {
      id: '34',
      name: 'Sarnia',
      color: '#14b8a6', // teal
      coordinates: [
        [-81.282701, 43.026757],
        [-81.281662, 43.027026],
        [-81.280699, 43.027199],
        [-81.28034, 43.027298],
        [-81.2836, 43.028441],
        [-81.284773, 43.030681],
        [-81.285676, 43.032406],
        [-81.287064, 43.035082],
        [-81.288199, 43.037251],
        [-81.292773, 43.037232],
        [-81.296077, 43.036254],
        [-81.295064, 43.034383],
        [-81.294296, 43.033359],
        [-81.294203, 43.032939],
        [-81.29435, 43.032192],
        [-81.295519, 43.031982],
        [-81.296418, 43.030827],
        [-81.295886, 43.02953],
        [-81.295278, 43.028393],
        [-81.296717, 43.027674],
        [-81.298908, 43.027151],
        [-81.30069, 43.026513],
        [-81.302076, 43.026076],
        [-81.299689, 43.021652],
        [-81.297765, 43.020641],
        [-81.295997, 43.021147],
        [-81.294059, 43.020913],
        [-81.293295, 43.020222],
        [-81.292565, 43.018903],
        [-81.291866, 43.017594],
        [-81.290979, 43.0165],
        [-81.289884, 43.015992],
        [-81.287248, 43.015749],
        [-81.285418, 43.016215],
        [-81.282299, 43.017175],
        [-81.278272, 43.018326],
        [-81.276793, 43.015458],
        [-81.276655, 43.014581],
        [-81.27698, 43.013012],
        [-81.277413, 43.011788],
        [-81.277357, 43.010294],
        [-81.275161, 43.009896],
        [-81.273005, 43.010201],
        [-81.271871, 43.009554],
        [-81.270822, 43.008367],
        [-81.269936, 43.008026],
        [-81.267246, 43.017921],
        [-81.272084, 43.016352],
        [-81.27354, 43.015898],
        [-81.275253, 43.015383],
        [-81.273207, 43.012214],
        [-81.271263, 43.011291],
        [-81.269838, 43.009976],
        [-81.269519, 43.00945],
        [-81.269525, 43.009355]
          ]
    }
  ];

const Map = () => {
  const mapContainer = useRef<HTMLDivElement>(null);
  const map = useRef<mapboxgl.Map | null>(null);
  const [mapError, setMapError] = useState<string | null>(null);
  const [visibleRoutes, setVisibleRoutes] = useState<string[]>(busRoutes.map(route => route.id));
  const [hoveredArea, setHoveredArea] = useState<typeof studentAreas[0] | null>(null);

  useEffect(() => {
    if (!mapContainer.current) return;
    
    if (!process.env.NEXT_PUBLIC_MAPBOX_TOKEN) {
      setMapError('Mapbox token is missing. Please check environment configuration.');
      return;
    }

    try {
      map.current = new mapboxgl.Map({
        container: mapContainer.current,
        style: "mapbox://styles/mapbox/light-v11",
        center: [-81.265, 43.005],
        zoom: 12,
      });

      map.current.on("load", () => {
        if (!map.current) return;
        console.log("Map loaded.");

        // Add student areas source
        map.current?.addSource("student-areas", {
          type: "geojson",
          data: {
            type: "FeatureCollection",
            features: studentAreas.map(area => ({
              type: "Feature",
              geometry: { type: "Polygon", coordinates: [area.boundary] },
              properties: { name: area.name, description: area.description, color: area.color },
            })),
          },
        });

        // Add student areas fill layer
        map.current?.addLayer({
          id: "student-area-fill",
          type: "fill",
          source: "student-areas",
          paint: {
            "fill-color": ["get", "color"],
            "fill-opacity": 0.2,
            "fill-outline-color": ["get", "color"],
          },
        });

        // Add student area outlines
        map.current?.addLayer({
          id: "student-area-outline",
          type: "line",
          source: "student-areas",
          paint: {
            "line-color": ["get", "color"],
            "line-width": 2,
          },
        });

        console.log("Student areas added.");

        // Add bus routes source
        map.current?.addSource("bus-routes", {
          type: "geojson",
          data: {
            type: "FeatureCollection",
            features: busRoutes.map(route => ({
              type: "Feature",
              geometry: { type: "LineString", coordinates: route.coordinates },
              properties: { id: route.id, name: route.name, color: route.color },
            })),
          },
        });

        // Add bus routes layer
        map.current?.addLayer({
          id: "bus-routes",
          type: "line",
          source: "bus-routes",
          paint: {
            "line-color": ["get", "color"],
            "line-width": 3,
            "line-opacity": 0.8,
          },
          filter: ["in", "id", ...visibleRoutes],
        });

        console.log("Bus routes added.");

        // Hover interactions
        map.current?.on("mousemove", "student-area-fill", (e) => {
          const feature = e.features?.[0]; // Optional chaining ensures we safely access the first feature
          if (!feature) return; // If there's no feature, exit early
        
          const area = studentAreas.find(a => a.name === feature.properties?.name);
          if (area) setHoveredArea(area);
        });
        
        map.current?.on("mouseleave", "student-area-fill", () => {
          if (map.current) map.current.getCanvas().style.cursor = "";
        });
      });
    } catch (error) {
      setMapError('Failed to initialize map. Please try again later.');
      console.error('Map initialization error:', error);
    }

    return () => map.current?.remove();
  }, []);

  // Toggle bus route visibility
  const toggleRoute = (routeId: string) => {
    setVisibleRoutes(prev =>
      prev.includes(routeId) ? prev.filter(id => id !== routeId) : [...prev, routeId]
    );
  };

  // Update route visibility
  useEffect(() => {
    if (map.current?.isStyleLoaded()) {
      console.log("Updating bus routes filter:", visibleRoutes);
      map.current.setFilter("bus-routes", ["in", ["get", "id"], ["literal", visibleRoutes]]);
    }
  }, [visibleRoutes]);

  return (
    <div className="flex flex-col-reverse md:flex-row gap-4">
      {/* Map Container */}
      <div className="w-full h-[450px] relative">
        {mapError ? (
          <div className="w-full h-full flex items-center justify-center bg-gray-100 rounded-lg">
            <p className="text-red-600">{mapError}</p>
          </div>
        ) : (
          <div ref={mapContainer} className="w-full h-full" />
        )}
        
        {/* Hover Info Box */}
        {hoveredArea && !mapError && (
          <div className="absolute top-4 left-4 bg-white p-3 rounded-lg shadow-lg">
            <h3 className="font-medium text-base">{hoveredArea.name}</h3>
            <p className="text-sm text-gray-600">{hoveredArea.description}</p>
          </div>
        )}
      </div>
  
      {/* Bus Route Toggles */}
      <div className="bg-white p-4 rounded-lg shadow-lg w-full md:w-[260px] order-last md:order-none">
        <h3 className="font-medium text-sm mb-3 hidden md:block">Bus Routes</h3>
        <div className="space-y-2">
          {busRoutes.map(route => (
            <button
              key={route.id}
              onClick={() => toggleRoute(route.id)}
              className={`flex items-center gap-3 w-full px-3 py-2 rounded-md transition ${
                visibleRoutes.includes(route.id)
                  ? "bg-opacity-10"
                  : "opacity-50 hover:opacity-75"
              }`}
              style={{ backgroundColor: `${route.color}20` }} // Light background matching route color
            >
              <span
                className="w-3 h-3 rounded-full"
                style={{ backgroundColor: route.color }}
            />
              {/* Display only the route number on mobile */}
              <span className="font-medium text-sm text-gray-800">{route.id} - {route.name}</span>
            </button>
          ))}
        </div>
      </div>
    </div>
  );
};

export default Map;
